# Based heavily on:
# http://tjelvarolsson.com/blog/how-to-continuously-test-your-python-code-on-windows-using-appveyor/

environment:
  matrix:
    - PYTHON_VERSION: 2.7
      MINICONDA: C:\Miniconda

init:
  - "ECHO %PYTHON_VERSION% %MINICONDA%"

platform:
  - x64

install:
  - "set PATH=%MINICONDA%;%MINICONDA%\\Scripts;%PATH%"

  # Check that we have the expected version and architecture for Python
  - "python --version"
  - "python -c \"import struct; print(struct.calcsize('P') * 8)\""

  - conda config --set always_yes yes --set changeps1 no
  - conda update -q conda
  - conda info -a

  - conda create --name autofalloff_conda pyside
  - activate autofalloff_conda
  - conda list

  - conda remove setuptools
  - conda list

  - conda install numpy
  - conda list

  # Not installed by default on appveyor
  #- conda remove distribute
  #- conda list
  #- conda remove setuptools
  #- conda list
  #- conda remove six

  #- conda remove distribute
  #- conda list

  - conda install pywin32
  - conda list

  - pip install pefile
  - pip install pyinstaller

  - conda install pyside
  - conda list
  - conda install six
  - conda list
  - conda install distribute
  - conda list
  - conda install pillow
  - conda list
  - conda install pyqtgraph
  - conda list
  - conda install pyserial
  - conda list

    #Copy C:\Miniconda2\envs\autofalloff_conda\Library\bin\mkl_avx.dll 
    # To:  scripts\built-dist\AutoFallOff

  - choco install -y InnoSetup
  - set PATH="C:\Program Files (x86)\Inno Setup 5";%PATH%

# Build is off because it is not applicable to python
build: off

test_script:
  # Run the project tests
     - "python setup.py develop"
     - "py.test tests/test_control.py -s -k test_controller_sees_default_state_on_startup"

after_test:

   - "pyinstaller \
      --clean \
      --distpath=scripts/built-dist \
      --workpath=scripts/work-path \
      --noconfirm \
      --icon autofalloff/assets/images/ApplicationIcon.ico \
      --specpath scripts \
      scripts/AutoFallOff.py"
      
   - "iscc scripts\\Application_InnoSetup.iss"
   - ps: "ls scripts\\built-dist\\*.exe"
   - ps: "ls scripts\\windows_installer\\*.exe"

   - ps: "7z a AutoFallOff.zip scripts\\built-dist"

artifacts:
   - path: AutoFallOff.zip
   - path: scripts\windows_installer\*.exe
